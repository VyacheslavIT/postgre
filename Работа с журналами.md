* Настройте выполнение контрольной точки раз в 30 секунд.
  
```sql
alter system set checkpoint_timeout = '30s';
ALTER SYSTEM
```
```sql
postgres=# show checkpoint_timeout;
 checkpoint_timeout 
--------------------
 30s
(1 row)
```

-----------------------------


* 10 минут c помощью утилиты pgbench подавайте нагрузку.
  
pgbench -T 600 pgbench
  


----------------------- 



* Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.
```sql
pgbench=# select * from pg_ls_waldir()
;
           name           |   size   |      modification      
--------------------------+----------+------------------------
 00000001000000000000003D | 16777216 | 2024-01-20 16:15:39+03
 00000001000000000000003F | 16777216 | 2024-01-20 16:14:27+03
 00000001000000000000003E | 16777216 | 2024-01-20 16:14:54+03
 00000001000000000000003C | 16777216 | 2024-01-20 16:15:04+03
(4 rows)
```

-rw------- 1 postgres postgres  16M Jan 20 16:16 00000001000000000000003D

-rw------- 1 postgres postgres  16M Jan 20 16:14 00000001000000000000003E

-rw------- 1 postgres postgres  16M Jan 20 16:14 00000001000000000000003F

-rw------- 1 postgres postgres  16M Jan 20 16:15 000000010000000000000040

drwx------ 2 postgres postgres 4.0K Jan  1 21:08 archive_status

Обьем wal сгенерированных файлов 64мб. (10*60)/30=20 контрольных точек, 64MB/20=3,2MB
На одну контрольную точку приходиться 3,2MB



----------------------------



* Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?
  
sudo /usr/lib/postgresql/15/bin/pg_controldata /var/lib/postgresql/15/main/

  Все контрольные точки выполнились по расписанию.
  
  

-----------------------------



* Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.

```sql
postgres=# show synchronous_commit;
 synchronous_commit 
--------------------
 off
(1 row)
```

tps = 7247.323213 (without initial connection time)

```sql

postgres=# show synchronous_commit;
 synchronous_commit 
--------------------
 on
(1 row)
```

tps = 769.632380 (without initial connection time)

Синхронная запись: При синхронной записи транзакция не считается завершенной, пока изменения не будут записаны на диск. Это гарантирует, что в случае сбоя системы данные останутся в целости и сохранности. Однако этот процесс может замедлить производительность, так как он требует больше времени на ожидание подтверждения от диска.

Асинхронная запись: Асинхронная запись позволяет транзакции завершиться быстрее, не дожидаясь записи на диск. Вместо этого PostgreSQL продолжает обрабатывать другие запросы, а изменения записываются на диск в фоновом режиме. Это может повысить производительность, но есть риск потери данных в случае сбоя.
  
-----------------------------



* Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер. Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?


```sql
postgres=# show data_checksums;
 data_checksums 
----------------
 off
(1 row)
```

sudo su - postgres -c '/usr/lib/postgresql/15/bin/pg_checksums --enable -D "/var/lib/postgresql/15/main"'

Checksum operation completed

Files scanned:   946

Blocks scanned:  2814

Files written:  778

Blocks written: 2814

pg_checksums: syncing data directory

pg_checksums: updating control file

Checksums enabled in cluster

```
postgres=# show data_checksums;
 data_checksums 
----------------
 on
(1 row)
```
```sql

postgres=# SELECT pg_relation_filepath('tbl3');
 pg_relation_filepath 
----------------------
 base/5/16388
(1 row)
```

------------------------------
