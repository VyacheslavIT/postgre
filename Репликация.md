* На 1 ВМ создаем таблицы test для записи, test2 для запросов на чтение.

Устанавливаем режим репликации 'logical'
```sql
alter system set wal_level = logical;
```

Перегружаем кластер для применения изменений 

sudo pg_ctlcluster 14 main restart

Проверяем режим репликации
```sql
test_vm1=# show wal_level;
 wal_level
-----------
 logical
(1 row)


```

Создаем таблицу для записи

```sql
Для записи

test_vm1=# create table test (name varchar(50));
CREATE TABLE


```

Создаем таблицу для чтения

```sql
Для чтения

test_vm1=# create table test2 (name varchar(50));
CREATE TABLE

```

Проверяем наличие таблиц

```sql
 \dt
         List of relations
 Schema | Name  | Type  |  Owner
--------+-------+-------+----------
 public | test  | table | postgres
 public | test2 | table | postgres
(2 rows)


```

-------------------------------------------------

* Создаем публикацию таблицы test и подписываемся на публикацию таблицы test2 с ВМ №2.

Создаем публикацию

```sql

test_vm1=# create publication table_test for table test;
CREATE PUBLICATION
test_vm1=#

Проверяем публикацию

\dRp+

test_vm1=# \dRp+
                           Publication table_test
  Owner   | All tables | Inserts | Updates | Deletes | Truncates | Via root
----------+------------+---------+---------+---------+-----------+----------
 postgres | f          | t       | t       | t       | t         | f
Tables:
    "public.test"

Создаем подписку

test_vm1=# create subscription table_test2
connection 'host=192.168.61.131 port=5432 user=postgres password=123 dbname=test_vm2'
publication table_test2 with (copy_data = true);
NOTICE:  created replication slot "table_test2" on publisher
CREATE SUBSCRIPTION

Проверяем подписку

 \dRs
             List of subscriptions
    Name     |  Owner   | Enabled | Publication
-------------+----------+---------+-------------
 table_test2 | postgres | t       | {test_pub}
(1 row)

test_vm1=# select * from pg_stat_subscription \gx
-[ RECORD 1 ]---------+------------------------------
subid                 | 16415
subname               | table_test2
pid                   | 15221
relid                 |
received_lsn          | 0/1755CE0
last_msg_send_time    | 2024-02-11 13:51:56.874553+00
last_msg_receipt_time | 2024-02-11 13:51:56.907659+00
latest_end_lsn        | 0/1755CE0
latest_end_time       | 2024-02-11 13:51:56.874553+00


```  


-------------------------------------------------


* На 2 ВМ создаем таблицы test2 для записи, test для запросов на чтение.

Устанавливаем режим репликации 'logical'

```sql
alter system set wal_level = logical;
```
Перегружаем кластер для применения изменений 

sudo pg_ctlcluster 14 main restart

Проверяем режим репликации

```sql
test_vm2=# show wal_level;
 wal_level
-----------
 logical
(1 row)


```

Создаем таблицу для записи

```sql
test_vm2=# create table test2 (name varchar(50));

```
Создаем таблицу для чтения

```sql

test_vm2=# create table test (name varchar(50));



```
Проверяем наличие таблиц

```sql

 \dt
         List of relations
 Schema | Name  | Type  |  Owner
--------+-------+-------+----------
 public | test  | table | postgres
 public | test2 | table | postgres
(2 rows)


```

--------------------------------------------------

* Создаем публикацию таблицы test2 и подписываемся на публикацию таблицы test1 с ВМ №1.

Создаем публикацию

```sql
test_vm2=# create publication table_test2 for table test2;
CREATE PUBLICATION

Проверяем публикацию

test_vm2=# \dRp+
                          Publication table_test2
  Owner   | All tables | Inserts | Updates | Deletes | Truncates | Via root
----------+------------+---------+---------+---------+-----------+----------
 postgres | f          | t       | t       | t       | t         | f
Tables:
    "public.test2"

Создаем подписку

test_vm2=# create subscription table_test
connection 'host=192.168.61.130 port=5432 user=postgres password=123 dbname=test_vm1'
publication table_test with (copy_data = true);
NOTICE:  created replication slot "table_test" on publisher
CREATE SUBSCRIPTION

Проверяем подписку

 \dRs
             List of subscriptions
    Name    |  Owner   | Enabled | Publication
------------+----------+---------+-------------
 table_test | postgres | t       | {test_pub}
(1 row)



test_vm2=# select * from pg_stat_subscription \gx
-[ RECORD 1 ]---------+------------------------------
subid                 | 16403
subname               | table_test
pid                   | 14633
relid                 |
received_lsn          | 0/176EC88
last_msg_send_time    | 2024-02-11 13:52:26.748163+00
last_msg_receipt_time | 2024-02-11 13:52:26.717782+00
latest_end_lsn        | 0/176EC88
latest_end_time       | 2024-02-11 13:52:26.748163+00


```


Проверяем таблицы, на обоих ВМ таблицы пусты.
```sql

test_vm1=# select * from test;
 name
------
(0 rows)

test_vm1=# select * from test2;
 name
------
(0 rows)


```

```sql

test_vm2=# select * from test;
 name
------
(0 rows)

test_vm2=# select * from test2;
 name
------
(0 rows)


```

Добавим записи в таблицу test на первой ВМ

```sql
test_vm1=# insert into test values ('1');
INSERT 0 1
test_vm1=# insert into test values ('2');
INSERT 0 1

На второй ВМ записи в таблице test появились

test_vm2=# select * from test;
 name
------
 1
 2
(2 rows)


```
Добавим записи в таблицу test2 на второй ВМ

```sql
test_vm2=# insert into test2 values ('1');
INSERT 0 1
test_vm2=# insert into test2 values ('2');
INSERT 0 1

На первой ВМ записи в таблице test2 появились

test_vm1=# select * from test2;
 name
------
 1
 2
(2 rows)


```



-------------------------------------------------

* 3 ВМ использовать как реплику для чтения и бэкапов (подписаться на таблицы из ВМ №1 и №2 ).




-----------------------------------------------


* co * реализовать горячее реплицирование для высокой доступности на 4ВМ. Источником должна выступать ВМ №3. Написать с какими проблемами столкнулись.
 
    
 
--------------------------------------------
